<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜æ†¶ã®åœ°å›³ - ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* iOSã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å¯¾ç­–: å‹•çš„ãªé«˜ã•ã‚’å–å¾— */
        :root { --app-height: 100dvh; }
        body { height: var(--app-height); overflow: hidden; }

        .view-hidden { display: none !important; }
        #map { width: 100%; height: 100%; background: #eef2f6; z-index: 10; }
        
        /* ãƒãƒ¼ã‚«ãƒ¼ã‚’å°‘ã—å°ã•ãã—ã¦ã‚¹ãƒãƒ›ã§ã®è¦–èªæ€§ã‚’å‘ä¸Š */
        .map-photo-marker { background: white; padding: 2px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border: 2px solid white; cursor: pointer; width: 80px !important; }
        .map-photo-marker img { width: 100%; height: 50px; object-fit: cover; border-radius: 3px; }
        .map-photo-marker div { font-size: 9px; text-align: center; font-weight: bold; overflow: hidden; white-space: nowrap; }

        /* å†™çœŸä¸€è¦§ï¼ˆæ‰‹æœ­ï¼‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        #hand-area { transition: transform 0.4s ease-out; }
        .hand-hidden { transform: translateY(80%); }
        .hand-visible { transform: translateY(0); }

        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .mic-active { animation: pulse 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 15px 8px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#f8f9fa]">

    <div id="home-view" class="h-full w-full relative">
        <div id="map"></div>
        <div class="absolute top-6 left-1/2 -translate-x-1/2 z-[1000] w-full px-4 text-center">
            <h1 class="inline-block text-xl md:text-3xl font-bold bg-white/90 px-6 py-2 rounded-full shadow-md text-gray-800 backdrop-blur-sm">è¨˜æ†¶ã®åœ°å›³</h1>
        </div>
        <div class="absolute bottom-8 right-8 z-[1000]">
            <label class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-2xl cursor-pointer flex items-center justify-center w-14 h-14 md:w-16 md:h-16 active:scale-90 transition-transform">
                <span class="text-2xl">+</span>
                <input type="file" id="photo-upload" multiple accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            </label>
        </div>
    </div>

    <div id="loading-overlay" class="fixed inset-0 bg-black/60 z-[9999] flex items-center justify-center view-hidden p-6">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-xs w-full">
            <div class="animate-spin h-10 w-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p id="loading-text" class="text-gray-700 font-bold">å†™çœŸã‚’æ•´ç†ä¸­...</p>
        </div>
    </div>

    <div id="trip-view" class="h-full w-full flex flex-col md:flex-row view-hidden">
        
        <div class="flex-grow relative bg-[#eef2f6] flex flex-col items-center justify-center overflow-hidden h-3/5 md:h-full">
            <div id="word-spawn-area" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
            
            <div class="z-10 bg-white p-2 md:p-4 shadow-xl rounded-2xl mx-4 max-w-[90%] md:max-w-2xl text-center">
                <img id="display-img" src="" class="rounded-lg w-full h-auto max-h-[30dvh] md:max-h-[60dvh] object-cover">
                <p id="display-caption" class="mt-2 md:mt-4 text-base md:text-xl font-bold italic text-gray-700 px-2"></p>
            </div>

            <div id="hand-container" class="absolute bottom-0 left-0 right-0 h-32 md:h-48 flex items-end justify-center z-20 overflow-hidden" 
                 onclick="toggleHand()" onmouseenter="showHand()" onmouseleave="hideHandIfSelected()">
                <div id="hand-area" class="flex justify-start md:justify-center -space-x-6 md:-space-x-4 px-10 pb-4 hand-hidden no-scrollbar overflow-x-auto w-full"></div>
            </div>
        </div>

        <div class="w-full md:w-80 lg:w-[380px] bg-white flex flex-col shadow-2xl z-30 h-2/5 md:h-full border-t md:border-t-0 md:border-l">
            <div class="flex-grow p-4 md:p-6 overflow-y-auto bg-gray-50/50 border-b no-scrollbar">
                <h3 class="text-gray-400 text-[10px] tracking-widest uppercase mb-2 font-bold">ä¼šè©±ã‹ã‚‰æ‹¾ã£ãŸè¨€è‘‰</h3>
                <div id="word-cloud-container" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div class="p-4 md:p-6 flex flex-col gap-3 md:gap-4 items-center">
                <button id="update-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs md:text-sm font-bold py-2 md:py-3 rounded-xl shadow-lg transition-all opacity-0 pointer-events-none">
                    <span id="update-btn-text">æ›´æ–°ã™ã‚‹</span>
                </button>
                
                <div class="flex gap-4 md:gap-6 items-center justify-center">
                    <button onclick="confirmGoHome()" class="bg-white border border-gray-200 text-lg w-10 h-10 md:w-12 md:h-12 rounded-full shadow-sm flex items-center justify-center">ğŸ </button>
                    <button id="mic-btn" onclick="toggleSpeechRecognition()" class="bg-red-500 text-white w-20 h-20 md:w-24 md:h-24 rounded-full shadow-xl flex flex-col items-center justify-center active:scale-95 transition-transform">
                        <span class="text-2xl md:text-3xl mb-1">ğŸ¤</span>
                        <span class="text-[8px] md:text-[9px] font-black uppercase">è©±ã™</span>
                    </button>
                    <button onclick="goBackToPreviousPhoto()" class="bg-white border border-gray-200 text-lg w-10 h-10 md:w-12 md:h-12 rounded-full shadow-sm flex items-center justify-center text-xl">â¬…ï¸</button>
                    <button id="delete-btn" onclick="deleteCurrentTrip()" class="bg-white border border-red-100 text-red-400 w-10 h-10 rounded-full shadow-sm flex items-center justify-center hidden">ğŸ—‘ï¸</button>
                </div>
            </div>

            <div class="p-4 md:p-6 bg-white border-t">
                <div class="w-full bg-blue-50 p-3 md:p-5 rounded-2xl border border-blue-100 min-h-[80px] md:min-h-[120px] flex items-center text-center">
                    <p id="ai-response-text" class="text-blue-900 text-xs md:text-sm font-medium leading-relaxed italic w-full"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const OPENAI_API_KEY = ''; 

        let map, currentTrip = '', currentPhotoSrc = '';
        let photoHistoryStack = [];
        let tripHistory = {
            ise: { name: "ä¼Šå‹¢", coords: [34.4912, 136.7099], thumbnail: 'ise1.jpg', photos: [{src: 'ise1.jpg'},{src: 'ise2.jpg'},{src: 'ise3.jpg'}], states: {} },
            nikko: { name: "æ—¥å…‰", coords: [36.7481, 139.6102], thumbnail: 'nikko1.jpg', photos: [{src: 'nikko1.jpg'},{src: 'nikko2.jpg'},{src: 'nikko3.jpg'}], states: {} }
        };
        let userTrips = JSON.parse(localStorage.getItem('USER_TRIPS')) || {};

        window.onload = () => { initMap(); };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([36.5, 137.5], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            Object.keys(tripHistory).forEach(id => renderMarker(id, tripHistory[id]));
            Object.keys(userTrips).forEach(id => renderMarker(id, userTrips[id], true));
        }

        function renderMarker(id, trip, isUser = false) {
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="map-photo-marker" onclick="diveToTrip('${id}')">
                        <img src="${trip.thumbnail}">
                        <div>${trip.name}</div>
                      </div>`,
                iconSize: [80, 75]
            });
            L.marker(trip.coords, {icon: icon}).addTo(map);
        }

        function diveToTrip(tripId) {
            currentTrip = tripId;
            const trip = { ...tripHistory, ...userTrips }[tripId];
            document.getElementById('home-view').classList.add('view-hidden');
            document.getElementById('trip-view').classList.remove('view-hidden');
            document.getElementById('delete-btn').classList.toggle('hidden', !tripId.startsWith('user_'));
            renderHand(trip);
            selectPhoto(trip.photos[0].src);
        }

        async function selectPhoto(src) {
            if (currentPhotoSrc && currentPhotoSrc !== src) photoHistoryStack.push(currentPhotoSrc);
            currentPhotoSrc = src;
            const trip = { ...tripHistory, ...userTrips }[currentTrip];
            if (!trip.states[src]) {
                trip.states[src] = { caption: "æ€ã„å‡ºã®ä¸€æš", keywords: [], visionSummary: "", welcome: "ã“ã®å†™çœŸã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚" };
                if (OPENAI_API_KEY) analyzeImage(src);
            }
            updateUI(trip.states[src]);
            document.getElementById('display-img').src = src;
            hideHandIfSelected();
        }

        function updateUI(state) {
            document.getElementById('display-caption').innerText = state.caption;
            document.getElementById('ai-response-text').innerText = `ã€Œ${state.welcome}ã€`;
            const container = document.getElementById('word-cloud-container');
            container.innerHTML = "";
            state.keywords.forEach(w => updateWordCloud(w));
        }

        async function analyzeImage(src) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{ role: "system", content: "summary:å ´æ‰€è¦ç´„ / caption:æƒ…ç·’çš„ãªä¸€è¨€(15å­—) / welcome:å•ã„ã‹ã‘ ã®å½¢å¼ã§" },
                        { role: "user", content: [{ type: "text", text: "è§£æã—ã¦" }, { type: "image_url", image_url: { url: src } }] }]
                    })
                });
                const data = await response.json();
                const res = data.choices[0].message.content.split('/');
                const state = { ...tripHistory, ...userTrips }[currentTrip].states[src];
                state.caption = res[1]?.replace('caption:', '').trim() || state.caption;
                state.welcome = res[2]?.replace('welcome:', '').trim() || state.welcome;
                if (currentPhotoSrc === src) updateUI(state);
            } catch (e) { console.warn("AIè§£æã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"); }
        }

        function resizeImage(blob, maxWidth) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(blob);
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    let width = img.width, height = img.height;
                    if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                };
                img.src = url;
            });
        }

        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('view-hidden');
            let processedCount = 0, lastGroupId = '';

            for (const file of files) {
                try {
                    let targetBlob = file;
                    if (file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif')) {
                        const converted = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.5 });
                        targetBlob = Array.isArray(converted) ? converted[0] : converted;
                    }

                    const coords = await new Promise((resolve) => {
                        EXIF.getData(targetBlob, function() {
                            const lat = EXIF.getTag(this, "GPSLatitude"), lon = EXIF.getTag(this, "GPSLongitude");
                            if (lat && lon) {
                                const toD = (dms, ref) => {
                                    let res = Number(dms[0]) + Number(dms[1])/60 + Number(dms[2])/3600;
                                    return (ref === "S" || ref === "W" ? res * -1 : res);
                                };
                                resolve([toD(lat, EXIF.getTag(this, "GPSLatitudeRef")), toD(lon, EXIF.getTag(this, "GPSLongitudeRef"))]);
                            } else {
                                resolve([35.68 + (Math.random()*0.1), 139.69 + (Math.random()*0.1)]); 
                            }
                        });
                    });

                    const resizedDataUrl = await resizeImage(targetBlob, 1000);
                    const gId = `user_${coords[0].toFixed(2)}_${coords[1].toFixed(2)}`;
                    if (!userTrips[gId]) {
                        userTrips[gId] = { id: gId, name: "æ–°ã—ã„æ—…", coords: coords, thumbnail: resizedDataUrl, photos: [], states: {} };
                    }
                    userTrips[gId].photos.push({ src: resizedDataUrl });
                    lastGroupId = gId; processedCount++;
                } catch (err) { console.error(err); }
            }

            overlay.classList.add('view-hidden');
            if (processedCount > 0) {
                localStorage.setItem('USER_TRIPS', JSON.stringify(userTrips));
                location.reload();
            } else {
                alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        async function askAI(text) {
            if (!OPENAI_API_KEY) return;
            const state = { ...tripHistory, ...userTrips }[currentTrip].states[currentPhotoSrc];
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{ role: "system", content: "cloud:å˜èª1,å˜èª2 / response:è¿”ç­” / memo:ãƒ¡ãƒ¢æ¡ˆ ã®å½¢å¼å³å®ˆ" }, { role: "user", content: text }]
                    })
                });
                const data = await response.json();
                const content = data.choices[0].message.content;
                const cloudMatch = content.match(/cloud:(.*?)(?=\/|$)/);
                const resMatch = content.match(/response:(.*?)(?=\/|$)/);
                const memoMatch = content.match(/memo:(.*?)(?=\/|$)/);

                if (cloudMatch) cloudMatch[1].split(',').forEach(w => {
                    const clean = w.trim();
                    if (clean && !state.keywords.includes(clean)) {
                        state.keywords.push(clean); updateWordCloud(clean);
                    }
                });
                if (resMatch) document.getElementById('ai-response-text').innerText = `ã€Œ${resMatch[1].trim()}ã€`;
                if (memoMatch) {
                    const memo = memoMatch[1].trim();
                    const btn = document.getElementById('update-btn');
                    btn.classList.remove('opacity-0', 'pointer-events-none');
                    document.getElementById('update-btn-text').innerText = `ã€Œ${memo}ã€ã«æ›´æ–°`;
                    btn.onclick = () => { document.getElementById('display-caption').innerText = memo; state.caption = memo; btn.classList.add('opacity-0'); };
                }
            } catch (e) { console.warn("AI Reply Error"); }
        }

        let isRec = false, rec = ('webkitSpeechRecognition' in window) ? new webkitSpeechRecognition() : null;
        if(rec) { rec.continuous = true; rec.onresult = (e) => askAI(e.results[e.results.length-1][0].transcript); }
        function toggleSpeechRecognition() {
            if(!rec) return alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜éå¯¾å¿œã§ã™");
            isRec ? rec.stop() : rec.start(); isRec = !isRec;
            document.getElementById('mic-btn').classList.toggle('mic-active', isRec);
        }

        function renderHand(trip) {
            const area = document.getElementById('hand-area'); area.innerHTML = '';
            trip.photos.forEach(p => {
                const card = document.createElement('div');
                card.className = "w-24 md:w-32 h-32 md:h-44 bg-white p-2 shadow-lg rounded-md cursor-pointer hover:scale-110 transition-transform flex-shrink-0";
                card.onclick = (e) => { e.stopPropagation(); selectPhoto(p.src); };
                card.innerHTML = `<img src="${p.src}" class="h-20 md:h-32 w-full object-cover rounded">`;
                area.appendChild(card);
            });
        }

        function updateWordCloud(word) {
            const container = document.getElementById('word-cloud-container');
            if ([...container.children].some(c => c.innerText === word)) return;
            const span = document.createElement('span');
            span.className = "floating text-xs md:text-sm text-blue-500 bg-white px-3 py-1 rounded-full shadow-sm border border-blue-50";
            span.innerText = word; container.appendChild(span);
        }

        function confirmGoHome() { if(confirm("åœ°å›³ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) location.reload(); }
        
        let handVisible = false;
        function toggleHand() { if(window.innerWidth < 768) { handVisible ? hideHandIfSelected() : showHand(); handVisible = !handVisible; } }
        function showHand() { document.getElementById('hand-area').classList.replace('hand-hidden', 'hand-visible'); }
        function hideHandIfSelected() { document.getElementById('hand-area').classList.replace('hand-visible', 'hand-hidden'); handVisible = false; }
        function goBackToPreviousPhoto() { if (photoHistoryStack.length > 0) selectPhoto(photoHistoryStack.pop()); }
        function deleteCurrentTrip() { if (confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { delete userTrips[currentTrip]; localStorage.setItem('USER_TRIPS', JSON.stringify(userTrips)); location.reload(); } }
    </script>
</body>
</html>
